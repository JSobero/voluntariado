<div class="contenedor-pagina">
  <div class="encabezado-pagina">
    <div class="encabezado-izquierda">
      <h1 class="titulo-pagina">
        <i class="icono-titulo bi bi-trophy-fill"></i>
        Gestión de Canjes
      </h1>
      <p class="subtitulo-pagina">Administra los canjes de recompensas realizados</p>
    </div>
  </div>

  <div class="grilla-estadisticas-mini">
    <div class="tarjeta-estadistica-mini estadistica-pendiente">
      <div class="icono-estadistica-mini"><i class="bi bi-clock-history"></i></div>
      <div class="contenido-estadistica-mini">
        <p class="valor-estadistica-mini">{{ obtenerCanjesPorEstado('PENDIENTE').length }}</p>
        <p class="etiqueta-estadistica-mini">Pendientes</p>
      </div>
    </div>
    <div class="tarjeta-estadistica-mini estadistica-entregado">
      <div class="icono-estadistica-mini"><i class="bi bi-check-circle-fill"></i></div>
      <div class="contenido-estadistica-mini">
        <p class="valor-estadistica-mini">{{ obtenerCanjesPorEstado('ENTREGADO').length }}</p>
        <p class="etiqueta-estadistica-mini">Entregados</p>
      </div>
    </div>
    <div class="tarjeta-estadistica-mini estadistica-cancelado">
      <div class="icono-estadistica-mini"><i class="bi bi-x-circle-fill"></i></div>
      <div class="contenido-estadistica-mini">
        <p class="valor-estadistica-mini">{{ obtenerCanjesPorEstado('CANCELADO').length }}</p>
        <p class="etiqueta-estadistica-mini">Cancelados</p>
      </div>
    </div>
    <div class="tarjeta-estadistica-mini estadistica-total">
      <div class="icono-estadistica-mini"><i class="bi bi-star-fill"></i></div>
      <div class="contenido-estadistica-mini">
        <p class="valor-estadistica-mini">{{ calcularTotalPuntosCanjeados() }}</p>
        <p class="etiqueta-estadistica-mini">Puntos Canjeados</p>
      </div>
    </div>
  </div>

  <div class="seccion-filtros">
    <div class="fila-filtros">
      <div class="contenedor-busqueda">
        <i class="icono-busqueda bi bi-search"></i>
        <input
          type="text"
          class="entrada-busqueda"
          placeholder="Buscar por usuario o recompensa..."
          [(ngModel)]="terminoBusqueda"
          (ngModelChange)="filtrarCanjes()">
      </div>

      <div class="grupo-filtros">
        <select class="selector-filtro" [(ngModel)]="filtroEstado" (change)="filtrarCanjes()">
          <option value="">Todos los estados</option>
          <option value="PENDIENTE">Pendientes</option>
          <option value="ENTREGADO">Entregados</option>
          <option value="CANCELADO">Cancelados</option>
        </select>

        <button class="boton-limpiar-filtros" (click)="limpiarFiltros()" *ngIf="terminoBusqueda || filtroEstado">
          <i class="bi bi-arrow-counterclockwise"></i> Limpiar
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="cargando" class="contenedor-carga">
    <div class="giratorio"></div>
    <p>Cargando canjes...</p>
  </div>

  <div *ngIf="!cargando" class="tarjeta-tabla">
    <div class="tabla-responsiva">
      <table class="tabla-datos">
        <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Recompensa</th>
          <th>Puntos</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let canje of canjesFiltrados" class="fila-tabla">
          <td class="celda-id">
            <span class="insignia-id">{{ canje.id }}</span>
          </td>

          <td class="celda-usuario">
            <div class="info-usuario">
              <div class="avatar-usuario">
                {{ canje.usuario.nombre.charAt(0).toUpperCase() }}
              </div>
              <div class="detalles-usuario">
                <div class="nombre-usuario">{{ canje.usuario.nombre }}</div>
                <div class="correo-usuario">{{ canje.usuario.correo }}</div>
              </div>
            </div>
          </td>

          <td class="celda-recompensa">
            <div class="info-recompensa">
              <i class="icono-recompensa bi bi-gift-fill"></i>
              <span class="nombre-recompensa">{{ canje.recompensa?.nombre || 'Recompensa eliminada' }}</span>
            </div>
          </td>

          <td class="celda-puntos">
            <div class="insignia-puntos">
              <i class="icono-puntos bi bi-star-fill"></i>
              <span class="valor-puntos">{{ canje.puntosUsados }}</span>
              <span class="etiqueta-puntos">pts</span>
            </div>
          </td>

          <td class="celda-fecha">
            <div class="info-fecha">
              <div class="fecha-completa">
                <i class="icono-fecha bi bi-calendar2-week"></i>
                {{ canje.fecha | date:'dd/MM/yyyy' }}
              </div>
              <div class="fecha-relativa">
                {{ obtenerTiempoTranscurrido(canje.fecha) }}
              </div>
            </div>
          </td>

          <td class="celda-estado">
            <select
              [(ngModel)]="canje.estado"
              (change)="actualizarEstado(canje)"
              [ngClass]="obtenerClaseEstado(canje.estado)"
              class="selector-estado">
              <option value="PENDIENTE">PENDIENTE</option>
              <option value="ENTREGADO">ENTREGADO</option>
              <option value="CANCELADO">CANCELADO</option>
            </select>
          </td>

          <td class="celda-acciones">
            <button class="boton-accion boton-eliminar" (click)="eliminarCanje(canje.id!)" title="Eliminar">
              <i class="bi bi-trash-fill"></i>
            </button>
          </td>
        </tr>
        </tbody>
      </table>

      <div *ngIf="canjesFiltrados.length === 0" class="estado-vacio">
        <div class="icono-vacio"><i class="bi bi-trophy"></i></div>
        <h3>No se encontraron canjes</h3>
        <p>{{ terminoBusqueda || filtroEstado ? 'Intenta con otros filtros' : 'No hay canjes registrados aún' }}</p>
        <button class="boton boton-secundario" (click)="limpiarFiltros()" *ngIf="terminoBusqueda || filtroEstado">
          <i class="bi bi-arrow-counterclockwise"></i> Limpiar filtros
        </button>
      </div>
    </div>
  </div>
</div>
